<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°è®°å½•å­˜æ¡£ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --base-font-size: 16px;
            --heading-scale: 1.5;
            --subheading-scale: 1.2;
            --body-scale: 1;
            --small-scale: 0.875;
            
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            
            --container-max-width: 1200px;
            --container-padding: 1.5rem;
        }

        html {
            font-size: var(--base-font-size);
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            padding: var(--spacing-sm);
            line-height: 1.6;
        }

        .container {
            max-width: var(--container-max-width);
            margin: 0 auto;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #4cc9f0;
            font-size: calc(var(--heading-scale) * 1rem);
            margin-bottom: var(--spacing-xs);
            line-height: 1.3;
        }

        .subtitle {
            color: #a0a0a0;
            font-size: calc(var(--subheading-scale) * 1rem);
        }

        .tab-navigation {
            display: flex;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .tab-button {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: none;
            color: #a0a0a0;
            font-size: calc(var(--body-scale) * 1rem);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.15);
            color: #4cc9f0;
            border-bottom: 3px solid #4cc9f0;
        }

        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: #e6e6e6;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.08);
            padding: var(--spacing-md);
            border-radius: 0 0 15px 15px;
            backdrop-filter: blur(10px);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .input-section, .records-section, .search-section {
            background: rgba(255, 255, 255, 0.1);
            padding: var(--spacing-md);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: var(--spacing-md);
        }

        .search-section {
            width: 100%;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-xs);
            color: #4cc9f0;
            font-weight: 600;
            font-size: calc(var(--body-scale) * 1rem);
        }

        input, textarea {
            width: 100%;
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 8px;
            color: #e6e6e6;
            font-size: calc(var(--body-scale) * 1rem);
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #4cc9f0;
            box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.3);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: 8px;
            font-size: calc(var(--body-scale) * 1rem);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4cc9f0, #4361ee);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: #e6e6e6;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f72585, #b5179e);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 37, 133, 0.5);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f8961e, #f3722c);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(248, 150, 30, 0.5);
        }

        .records-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            background: rgba(255, 255, 255, 0.08);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border-radius: 10px;
            border-left: 4px solid #4cc9f0;
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .record-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.12);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }

        .record-name {
            font-weight: 600;
            color: #4cc9f0;
            font-size: calc(var(--subheading-scale) * 1rem);
        }

        .record-date {
            color: #a0a0a0;
            font-size: calc(var(--small-scale) * 1rem);
        }

        .record-content {
            color: #cccccc;
            line-height: 1.5;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: #a0a0a0;
        }

        .file-input-group {
            margin-top: var(--spacing-md);
        }

        .file-input {
            background: rgba(255, 255, 255, 0.08);
            padding: var(--spacing-sm);
            border-radius: 8px;
            margin-bottom: var(--spacing-sm);
        }

        .status-message {
            padding: var(--spacing-sm);
            border-radius: 5px;
            margin: var(--spacing-sm) 0;
            text-align: center;
            font-weight: 600;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        .search-results {
            margin-top: var(--spacing-md);
        }

        .search-highlight {
            background-color: rgba(76, 201, 240, 0.4);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .search-stats {
            color: #a0a0a0;
            margin-bottom: var(--spacing-md);
            font-size: calc(var(--small-scale) * 1rem);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: var(--spacing-sm);
        }

        .modal {
            background: rgba(26, 26, 46, 0.95);
            padding: var(--spacing-md);
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .modal-title {
            color: #4cc9f0;
            margin-bottom: var(--spacing-md);
            font-size: calc(var(--subheading-scale) * 1rem);
            text-align: center;
        }

        .modal-content {
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }

        .existing-record {
            background: rgba(255, 255, 255, 0.08);
            padding: var(--spacing-md);
            border-radius: 8px;
            margin: var(--spacing-md) 0;
            border-left: 3px solid #f8961e;
        }

        .record-preview {
            max-height: 150px;
            overflow-y: auto;
            margin-top: var(--spacing-sm);
        }

        .modal-buttons {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .modal-btn {
            flex: 1;
            min-width: 100px;
        }

        .hidden {
            display: none;
        }

        .record-detail {
            background: rgba(255, 255, 255, 0.08);
            padding: var(--spacing-md);
            border-radius: 10px;
            margin: var(--spacing-md) 0;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            flex-wrap: wrap;
        }

        .detail-name {
            font-size: calc(var(--subheading-scale) * 1rem);
            font-weight: 600;
            color: #4cc9f0;
            margin-bottom: var(--spacing-xs);
        }

        .detail-date {
            color: #a0a0a0;
            font-size: calc(var(--small-scale) * 1rem);
        }

        .detail-content {
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            padding: var(--spacing-sm);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-sm);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            font-size: calc(var(--small-scale) * 1rem);
            color: #a0a0a0;
            flex-wrap: wrap;
        }

        .time-item {
            display: flex;
            flex-direction: column;
            margin-bottom: var(--spacing-xs);
        }

        .time-label {
            font-size: calc(var(--small-scale) * 0.9rem);
            margin-bottom: 3px;
        }

        .time-value {
            font-weight: 600;
            color: #e6e6e6;
        }

        .recent-records-container {
            margin-top: var(--spacing-md);
        }

        .confirmation-modal .modal-content {
            text-align: center;
        }

        .confirmation-icon {
            font-size: 3em;
            margin-bottom: var(--spacing-md);
        }

        .confirmation-text {
            font-size: calc(var(--body-scale) * 1rem);
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }

        .confirmation-stats {
            background: rgba(255, 255, 255, 0.08);
            padding: var(--spacing-md);
            border-radius: 8px;
            margin: var(--spacing-md) 0;
            border-left: 3px solid #f72585;
        }

        .export-options {
            background: rgba(255, 255, 255, 0.08);
            padding: var(--spacing-md);
            border-radius: 8px;
            margin: var(--spacing-md) 0;
            border-left: 3px solid #4cc9f0;
        }

        .filename-preview {
            background: rgba(0, 0, 0, 0.3);
            padding: var(--spacing-sm);
            border-radius: 5px;
            margin-top: var(--spacing-sm);
            font-family: monospace;
            font-size: calc(var(--small-scale) * 1rem);
            word-break: break-all;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            :root {
                --base-font-size: 14px;
                --container-padding: 1rem;
            }
            
            body {
                padding: var(--spacing-xs);
            }
            
            .tab-button {
                padding: var(--spacing-sm) var(--spacing-xs);
                font-size: calc(var(--small-scale) * 1rem);
            }
            
            .tab-content {
                padding: var(--spacing-sm);
            }
            
            .input-section, .records-section, .search-section {
                padding: var(--spacing-sm);
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-bottom: var(--spacing-xs);
            }
            
            .modal {
                padding: var(--spacing-sm);
            }
            
            .detail-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .time-info {
                flex-direction: column;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
                margin-bottom: var(--spacing-xs);
            }
        }

        @media (max-width: 480px) {
            :root {
                --base-font-size: 13px;
            }
            
            h1 {
                font-size: calc(var(--heading-scale) * 0.9rem);
            }
            
            .tab-navigation {
                flex-direction: column;
            }
            
            .tab-button {
                border-radius: 0;
            }
            
            .tab-button:first-child {
                border-radius: 10px 10px 0 0;
            }
            
            .tab-button:last-child {
                border-radius: 0 0 10px 10px;
            }
        }

        @media (min-width: 1200px) {
            :root {
                --base-font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ æœ¬åœ°è®°å½•å­˜æ¡£ç³»ç»Ÿ</h1>
            <p class="subtitle">å®‰å…¨ã€ä¾¿æ·çš„æœ¬åœ°è®°å½•ç®¡ç†ä¸å­˜æ¡£è§£å†³æ–¹æ¡ˆ</p>
        </header>

        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('search-tab')">ğŸ” æœç´¢è®°å½•</button>
            <button class="tab-button" onclick="switchTab('add-tab')">â• æ·»åŠ è®°å½•</button>
            <button class="tab-button" onclick="switchTab('view-tab')">ğŸ“‹ æŸ¥çœ‹è®°å½•</button>
        </div>

        <!-- æœç´¢æ ‡ç­¾é¡µ -->
        <div id="search-tab" class="tab-content active">
            <div class="search-section">
                <h2>ğŸ” æœç´¢è®°å½•</h2>
                <div class="form-group">
                    <label for="searchInput">æœç´¢å…³é”®è¯</label>
                    <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯æœç´¢è®°å½•åç§°æˆ–å†…å®¹..." oninput="performSearch()">
                </div>
                
                <div class="search-stats" id="searchStats">
                    è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢...
                </div>
                
                <!-- æœ€è¿‘è®°å½•å®¹å™¨ - ä»…åœ¨æœç´¢æ¡†ä¸ºç©ºæ—¶æ˜¾ç¤º -->
                <div id="recent-records-container" class="recent-records-container">
                    <h2>æœ€è¿‘è®°å½• (<span id="recentRecordCount">0</span>)</h2>
                    <div class="records-list" id="recentRecordsList">
                        <div class="empty-state">
                            <p>æš‚æ— è®°å½•</p>
                            <p>æ·»åŠ ç¬¬ä¸€æ¡è®°å½•å¼€å§‹ä½¿ç”¨</p>
                        </div>
                    </div>
                </div>
                
                <!-- æœç´¢ç»“æœå®¹å™¨ -->
                <div class="search-results" id="searchResults" style="display: none;">
                    <div class="empty-state">
                        <p>ç­‰å¾…æœç´¢...</p>
                        <p>åœ¨æœç´¢æ¡†ä¸­è¾“å…¥å…³é”®è¯æ¥æŸ¥æ‰¾è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ è®°å½•æ ‡ç­¾é¡µ -->
        <div id="add-tab" class="tab-content">
            <div class="input-section">
                <h2>æ·»åŠ æ–°è®°å½•</h2>
                <div class="form-group">
                    <label for="recordName">åç§° *</label>
                    <input type="text" id="recordName" placeholder="è¾“å…¥è®°å½•åç§°" required>
                </div>
                
                <div class="form-group">
                    <label for="recordContent">å†…å®¹ *</label>
                    <textarea id="recordContent" placeholder="è¾“å…¥è®°å½•å†…å®¹" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="recordDate">æ›´æ–°æ—¥æœŸ *</label>
                    <input type="date" id="recordDate" required>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ä¿å­˜è®°å½•</button>
                    <button class="btn btn-secondary" onclick="clearForm()">ğŸ—‘ï¸ æ¸…é™¤è¡¨å•</button>
                </div>

                <div class="file-input-group">
                    <h3>å¯¼å…¥å­˜æ¡£æ–‡ä»¶</h3>
                    <div class="file-input">
                        <input type="file" id="fileInput" accept=".txt" onchange="importRecords(this.files[0])">
                    </div>
                </div>
            </div>
        </div>

        <!-- æŸ¥çœ‹è®°å½•æ ‡ç­¾é¡µ -->
        <div id="view-tab" class="tab-content">
            <div class="records-section">
                <h2>æ‰€æœ‰è®°å½• (<span id="recordCount">0</span>)</h2>
                
                <!-- å¯¼å‡ºé€‰é¡¹ -->
                <div class="export-options">
                    <h3>å¯¼å‡ºé€‰é¡¹</h3>
                    <div class="form-group">
                        <label for="exportFileName">å¯¼å‡ºæ–‡ä»¶å</label>
                        <input type="text" id="exportFileName" placeholder="è¾“å…¥è‡ªå®šä¹‰æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰" value="è®°å½•å­˜æ¡£">
                        <div class="filename-preview">
                            é¢„è§ˆ: <span id="filenamePreview">è®°å½•å­˜æ¡£_YYYY-MM-DD.txt</span>
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="exportRecords()">ğŸ“¤ å¯¼å‡ºå­˜æ¡£</button>
                    <button class="btn btn-danger" onclick="showClearConfirmation()">âš ï¸ æ¸…é™¤æ‰€æœ‰è®°å½•</button>
                </div>
                
                <div class="records-list" id="recordsList">
                    <div class="empty-state">
                        <p>æš‚æ— è®°å½•</p>
                        <p>æ·»åŠ ç¬¬ä¸€æ¡è®°å½•å¼€å§‹ä½¿ç”¨</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="statusMessage"></div>
    </div>

    <!-- å†²çªå¤„ç†æ¨¡æ€æ¡† -->
    <div id="conflictModal" class="modal-overlay hidden">
        <div class="modal">
            <h3 class="modal-title">ğŸ“ è®°å½•åç§°å†²çª</h3>
            <div class="modal-content">
                <p>è®°å½•åç§° "<span id="conflictName"></span>" å·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š</p>
                
                <div class="existing-record">
                    <strong>ç°æœ‰è®°å½•å†…å®¹ï¼š</strong>
                    <div class="record-preview" id="existingRecordContent"></div>
                    <div><small>åˆ›å»ºæ—¥æœŸï¼š<span id="existingRecordCreateDate"></span></small></div>
                    <div><small>æœ€åæ›´æ–°ï¼š<span id="existingRecordUpdateDate"></span></small></div>
                </div>
                
                <div>
                    <strong>æ–°è®°å½•å†…å®¹ï¼š</strong>
                    <div class="record-preview" id="newRecordContent"></div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary modal-btn" onclick="handleConflict('view')">ğŸ‘ï¸ æŸ¥çœ‹</button>
                <button class="btn btn-warning modal-btn" onclick="handleConflict('update')">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-primary modal-btn" onclick="handleConflict('append')">ğŸ“ è¿½åŠ </button>
                <button class="btn btn-secondary modal-btn" onclick="hideConflictModal()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è®°å½•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal-overlay hidden">
        <div class="modal">
            <h3 class="modal-title">ğŸ“„ è®°å½•è¯¦æƒ…</h3>
            <div class="modal-content">
                <div class="record-detail">
                    <div class="detail-header">
                        <span class="detail-name" id="detailName"></span>
                        <span class="detail-date" id="detailDate"></span>
                    </div>
                    <div class="detail-content" id="detailContent"></div>
                    <div class="time-info">
                        <div class="time-item">
                            <span class="time-label">åˆ›å»ºæ—¶é—´</span>
                            <span class="time-value" id="detailCreateTime"></span>
                        </div>
                        <div class="time-item">
                            <span class="time-label">æœ€åæ›´æ–°æ—¶é—´</span>
                            <span class="time-value" id="detailUpdateTime"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-danger modal-btn" id="deleteRecordBtn">ğŸ—‘ï¸ åˆ é™¤è®°å½•</button>
                <button class="btn btn-secondary modal-btn" onclick="hideDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ¸…é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="clearConfirmationModal" class="modal-overlay hidden">
        <div class="modal confirmation-modal">
            <h3 class="modal-title">âš ï¸ ç¡®è®¤æ¸…é™¤æ‰€æœ‰è®°å½•</h3>
            <div class="modal-content">
                <div class="confirmation-icon">ğŸ—‘ï¸</div>
                <div class="confirmation-text">
                    <p>æ‚¨ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿ</p>
                    <p>æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰ä¿å­˜çš„è®°å½•ï¼Œä¸”æ— æ³•æ’¤é”€ï¼</p>
                </div>
                <div class="confirmation-stats">
                    <p><strong>å°†æ¸…é™¤çš„è®°å½•æ•°é‡ï¼š</strong> <span id="clearRecordCount">0</span> æ¡</p>
                    <p><strong>æ“ä½œç±»å‹ï¼š</strong> æ°¸ä¹…åˆ é™¤</p>
                    <p><strong>å½±å“ï¼š</strong> æ‰€æœ‰æ•°æ®å°†æ— æ³•æ¢å¤</p>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-danger modal-btn" onclick="confirmClearAllRecords()">ğŸ—‘ï¸ ç¡®è®¤æ¸…é™¤</button>
                <button class="btn btn-secondary modal-btn" onclick="hideClearConfirmation()">âŒ å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('recordDate').valueAsDate = new Date();

        // åŠ è½½ä¿å­˜çš„è®°å½•
        let records = JSON.parse(localStorage.getItem('recordArchive') || '[]');
        // è¿ç§»æ—§æ•°æ®æ ¼å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        migrateOldDataFormat();
        
        let currentConflictData = null;
        let currentDetailRecord = null;
        
        updateRecordsDisplay();
        updateRecentRecordsDisplay();
        
        // åˆå§‹åŒ–æœç´¢æ ‡ç­¾é¡µæ˜¾ç¤ºçŠ¶æ€
        performSearch();
        
        // åˆå§‹åŒ–æ–‡ä»¶åé¢„è§ˆ
        updateFilenamePreview();

        // è¿ç§»æ—§æ•°æ®æ ¼å¼ï¼ˆä»å•ä¸€æ—¥æœŸå­—æ®µè¿ç§»åˆ°åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´ï¼‰
        function migrateOldDataFormat() {
            let needsMigration = false;
            
            for (let record of records) {
                if (record.date && !record.createTime) {
                    // æ—§æ ¼å¼æ•°æ®ï¼Œè¿ç§»åˆ°æ–°æ ¼å¼
                    record.createTime = record.date;
                    record.updateTime = record.date;
                    needsMigration = true;
                }
            }
            
            if (needsMigration) {
                localStorage.setItem('recordArchive', JSON.stringify(records));
            }
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function switchTab(tabId) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabId).classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            event.target.classList.add('active');
            
            // å¦‚æœæ˜¯æŸ¥çœ‹è®°å½•æ ‡ç­¾é¡µï¼Œæ ¹æ®æœç´¢æ¡†å†…å®¹æ›´æ–°æ˜¾ç¤º
            if (tabId === 'view-tab') {
                updateFilenamePreview();
            }
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }

        function saveRecord() {
            const name = document.getElementById('recordName').value.trim();
            const content = document.getElementById('recordContent').value.trim();
            const date = document.getElementById('recordDate').value;
            const currentTime = new Date().toISOString().split('T')[0];

            if (!name || !content || !date) {
                showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåè®°å½•
            const existingIndex = records.findIndex(record => record.name === name);
            
            if (existingIndex !== -1) {
                // æ˜¾ç¤ºå†²çªå¤„ç†æ¨¡æ€æ¡†
                showConflictModal(name, content, date, existingIndex);
            } else {
                // æ·»åŠ æ–°è®°å½•
                addNewRecord(name, content, date, currentTime);
            }
        }

        function showConflictModal(name, newContent, newDate, existingIndex) {
            const existingRecord = records[existingIndex];
            
            // ä¿å­˜å½“å‰å†²çªæ•°æ®
            currentConflictData = {
                name,
                newContent,
                newDate,
                existingIndex
            };
            
            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('conflictName').textContent = name;
            document.getElementById('existingRecordContent').textContent = existingRecord.content;
            document.getElementById('existingRecordCreateDate').textContent = formatDate(existingRecord.createTime || existingRecord.date);
            document.getElementById('existingRecordUpdateDate').textContent = formatDate(existingRecord.updateTime || existingRecord.date);
            document.getElementById('newRecordContent').textContent = newContent;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('conflictModal').classList.remove('hidden');
        }

        function hideConflictModal() {
            document.getElementById('conflictModal').classList.add('hidden');
            currentConflictData = null;
        }

        function handleConflict(action) {
            if (!currentConflictData) return;
            
            const { name, newContent, newDate, existingIndex } = currentConflictData;
            const existingRecord = records[existingIndex];
            const currentTime = new Date().toISOString().split('T')[0];
            
            switch (action) {
                case 'view':
                    // åˆ‡æ¢åˆ°æŸ¥çœ‹æ ‡ç­¾é¡µå¹¶æ˜¾ç¤ºè¯¦æƒ…
                    hideConflictModal();
                    switchTab('view-tab');
                    showRecordDetail(existingRecord);
                    showStatus(`å·²åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼ï¼Œè®°å½• "${name}" æœªä¿®æ”¹`);
                    break;
                    
                case 'update':
                    // æ›´æ–°ç°æœ‰è®°å½•
                    records[existingIndex] = { 
                        name, 
                        content: newContent, 
                        date: newDate,
                        createTime: existingRecord.createTime || existingRecord.date,
                        updateTime: currentTime
                    };
                    saveAndUpdateDisplay(`è®°å½• "${name}" å·²æ›´æ–°`);
                    break;
                    
                case 'append':
                    // è¿½åŠ å†…å®¹åˆ°ç°æœ‰è®°å½•ï¼Œä¿ç•™åŸå§‹åˆ›å»ºæ—¶é—´
                    records[existingIndex] = { 
                        name, 
                        content: existingRecord.content + '\n\n--- è¿½åŠ å†…å®¹ (' + formatDate(currentTime) + ') ---\n' + newContent, 
                        date: newDate,
                        createTime: existingRecord.createTime || existingRecord.date,
                        updateTime: currentTime
                    };
                    saveAndUpdateDisplay(`è®°å½• "${name}" å·²è¿½åŠ å†…å®¹`);
                    break;
            }
            
            hideConflictModal();
        }

        function addNewRecord(name, content, date, createTime) {
            // æ·»åŠ æ–°è®°å½•
            records.push({ 
                name, 
                content, 
                date,
                createTime: createTime,
                updateTime: createTime
            });
            saveAndUpdateDisplay(`è®°å½• "${name}" å·²ä¿å­˜`);
        }

        function saveAndUpdateDisplay(message) {
            // æŒ‰æ—¥æœŸé™åºæ’åº
            records.sort((a, b) => new Date(b.updateTime || b.date) - new Date(a.updateTime || a.date));
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('recordArchive', JSON.stringify(records));
            
            // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
            updateRecordsDisplay();
            updateRecentRecordsDisplay();
            clearForm();
            
            // å¦‚æœå½“å‰åœ¨æœç´¢æ ‡ç­¾é¡µï¼Œæ›´æ–°æœç´¢æ˜¾ç¤º
            if (document.getElementById('search-tab').classList.contains('active')) {
                performSearch();
            }
            
            showStatus(message);
        }

        function clearForm() {
            document.getElementById('recordName').value = '';
            document.getElementById('recordContent').value = '';
            document.getElementById('recordDate').valueAsDate = new Date();
        }

        function updateRecordsDisplay() {
            const recordsList = document.getElementById('recordsList');
            const recordCount = document.getElementById('recordCount');
            
            recordCount.textContent = records.length;

            if (records.length === 0) {
                recordsList.innerHTML = '<div class="empty-state"><p>æš‚æ— è®°å½•</p><p>æ·»åŠ ç¬¬ä¸€æ¡è®°å½•å¼€å§‹ä½¿ç”¨</p></div>';
                return;
            }

            recordsList.innerHTML = records.map(record => `
                <div class="record-item" onclick="showRecordDetail(${escapeHtml(JSON.stringify(record))})">
                    <div class="record-header">
                        <span class="record-name">${escapeHtml(record.name)}</span>
                        <span class="record-date">${formatDate(record.updateTime || record.date)}</span>
                    </div>
                    <div class="record-content">${escapeHtml(record.content)}</div>
                </div>
            `).join('');
        }

        function updateRecentRecordsDisplay() {
            const recentRecordsList = document.getElementById('recentRecordsList');
            const recentRecordCount = document.getElementById('recentRecordCount');
            const recentRecords = records.slice(0, 5); // æ˜¾ç¤ºæœ€è¿‘5æ¡è®°å½•
            
            recentRecordCount.textContent = recentRecords.length;

            if (recentRecords.length === 0) {
                recentRecordsList.innerHTML = '<div class="empty-state"><p>æš‚æ— è®°å½•</p><p>æ·»åŠ ç¬¬ä¸€æ¡è®°å½•å¼€å§‹ä½¿ç”¨</p></div>';
                return;
            }

            recentRecordsList.innerHTML = recentRecords.map(record => `
                <div class="record-item" onclick="showRecordDetail(${escapeHtml(JSON.stringify(record))})">
                    <div class="record-header">
                        <span class="record-name">${escapeHtml(record.name)}</span>
                        <span class="record-date">${formatDate(record.updateTime || record.date)}</span>
                    </div>
                    <div class="record-content">${escapeHtml(record.content)}</div>
                </div>
            `).join('');
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            const searchStats = document.getElementById('searchStats');
            const recentRecordsContainer = document.getElementById('recent-records-container');
            
            if (!searchTerm) {
                // æœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæœ€è¿‘è®°å½•ï¼Œéšè—æœç´¢ç»“æœ
                recentRecordsContainer.style.display = 'block';
                searchResults.style.display = 'none';
                searchStats.innerHTML = 'æ˜¾ç¤ºæœ€è¿‘è®°å½•';
                return;
            }

            // æœ‰å…³é”®è¯ï¼Œéšè—æœ€è¿‘è®°å½•ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœ
            recentRecordsContainer.style.display = 'none';
            searchResults.style.display = 'block';

            const filteredRecords = records.filter(record => 
                record.name.toLowerCase().includes(searchTerm) || 
                record.content.toLowerCase().includes(searchTerm)
            );

            searchStats.innerHTML = `æ‰¾åˆ° ${filteredRecords.length} æ¡åŒ¹é…è®°å½•ï¼ˆå…³é”®è¯ï¼š${escapeHtml(searchTerm)}ï¼‰`;

            if (filteredRecords.length === 0) {
                searchResults.innerHTML = '<div class="empty-state"><p>æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•</p><p>å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢</p></div>';
                return;
            }

            searchResults.innerHTML = filteredRecords.map(record => {
                const highlightedName = highlightText(record.name, searchTerm);
                const highlightedContent = highlightText(record.content, searchTerm);
                
                return `
                    <div class="record-item" onclick="showRecordDetail(${escapeHtml(JSON.stringify(record))})">
                        <div class="record-header">
                            <span class="record-name">${highlightedName}</span>
                            <span class="record-date">${formatDate(record.updateTime || record.date)}</span>
                        </div>
                        <div class="record-content">${highlightedContent}</div>
                    </div>
                `;
            }).join('');
        }

        function showRecordDetail(record) {
            // ä¿å­˜å½“å‰æŸ¥çœ‹çš„è®°å½•
            currentDetailRecord = record;
            
            document.getElementById('detailName').textContent = record.name;
            document.getElementById('detailDate').textContent = formatDate(record.updateTime || record.date);
            document.getElementById('detailContent').textContent = record.content;
            document.getElementById('detailCreateTime').textContent = formatDateTime(record.createTime || record.date);
            document.getElementById('detailUpdateTime').textContent = formatDateTime(record.updateTime || record.date);
            
            // è®¾ç½®åˆ é™¤æŒ‰é’®äº‹ä»¶
            document.getElementById('deleteRecordBtn').onclick = function() {
                deleteRecord(record);
            };
            
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function hideDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
            currentDetailRecord = null;
        }

        function deleteRecord(record) {
            if (!record) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤è®°å½• "${record.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                const index = records.findIndex(r => r.name === record.name);
                if (index !== -1) {
                    records.splice(index, 1);
                    localStorage.setItem('recordArchive', JSON.stringify(records));
                    
                    // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                    updateRecordsDisplay();
                    updateRecentRecordsDisplay();
                    
                    // å¦‚æœå½“å‰åœ¨æœç´¢æ ‡ç­¾é¡µï¼Œæ›´æ–°æœç´¢æ˜¾ç¤º
                    if (document.getElementById('search-tab').classList.contains('active')) {
                        performSearch();
                    }
                    
                    hideDetailModal();
                    showStatus(`è®°å½• "${record.name}" å·²åˆ é™¤`);
                }
            }
        }

        // æ›´æ–°æ–‡ä»¶åé¢„è§ˆ
        function updateFilenamePreview() {
            const fileNameInput = document.getElementById('exportFileName');
            const previewSpan = document.getElementById('filenamePreview');
            
            fileNameInput.addEventListener('input', function() {
                const customName = this.value.trim();
                const today = new Date().toISOString().split('T')[0];
                
                if (customName) {
                    previewSpan.textContent = `${customName}_${today}.txt`;
                } else {
                    previewSpan.textContent = `è®°å½•å­˜æ¡£_${today}.txt`;
                }
            });
            
            // åˆå§‹é¢„è§ˆ
            const today = new Date().toISOString().split('T')[0];
            const customName = fileNameInput.value.trim();
            previewSpan.textContent = customName ? `${customName}_${today}.txt` : `è®°å½•å­˜æ¡£_${today}.txt`;
        }

        function exportRecords() {
            if (records.length === 0) {
                showStatus('æ²¡æœ‰è®°å½•å¯å¯¼å‡º', 'error');
                return;
            }

            const customFileName = document.getElementById('exportFileName').value.trim();
            const today = new Date().toISOString().split('T')[0];
            
            // ç¡®å®šæœ€ç»ˆæ–‡ä»¶å
            let fileName;
            if (customFileName) {
                fileName = `${customFileName}_${today}.txt`;
            } else {
                fileName = `è®°å½•å­˜æ¡£_${today}.txt`;
            }

            const dataStr = JSON.stringify(records, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'text/plain' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = fileName;
            link.click();
            
            showStatus(`å·²å¯¼å‡º ${records.length} æ¡è®°å½•åˆ° ${fileName}`);
        }

        function importRecords(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedRecords = JSON.parse(e.target.result);
                    let addedCount = 0;
                    let updatedCount = 0;

                    importedRecords.forEach(importedRecord => {
                        // è¿ç§»å¯¼å…¥çš„è®°å½•æ ¼å¼
                        if (importedRecord.date && !importedRecord.createTime) {
                            importedRecord.createTime = importedRecord.date;
                            importedRecord.updateTime = importedRecord.date;
                        }
                        
                        const existingIndex = records.findIndex(record => record.name === importedRecord.name);
                        
                        if (existingIndex !== -1) {
                            // æ›´æ–°ç°æœ‰è®°å½•
                            records[existingIndex] = importedRecord;
                            updatedCount++;
                        } else {
                            // æ·»åŠ æ–°è®°å½•
                            records.push(importedRecord);
                            addedCount++;
                        }
                    });

                    // é‡æ–°æ’åº
                    records.sort((a, b) => new Date(b.updateTime || b.date) - new Date(a.updateTime || a.date));
                    localStorage.setItem('recordArchive', JSON.stringify(records));
                    updateRecordsDisplay();
                    updateRecentRecordsDisplay();

                    let message = 'å¯¼å…¥å®Œæˆ';
                    if (addedCount > 0) message += `ï¼Œæ–°å¢ ${addedCount} æ¡è®°å½•`;
                    if (updatedCount > 0) message += `ï¼Œæ›´æ–° ${updatedCount} æ¡è®°å½•`;
                    
                    showStatus(message);
                    
                } catch (error) {
                    showStatus('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œå¯¼å…¥å¤±è´¥', 'error');
                }
            };
            reader.readAsText(file);
        }

        function showClearConfirmation() {
            if (records.length === 0) {
                showStatus('æ²¡æœ‰è®°å½•å¯æ¸…é™¤', 'error');
                return;
            }

            document.getElementById('clearRecordCount').textContent = records.length;
            document.getElementById('clearConfirmationModal').classList.remove('hidden');
        }

        function hideClearConfirmation() {
            document.getElementById('clearConfirmationModal').classList.add('hidden');
        }

        function confirmClearAllRecords() {
            records = [];
            localStorage.removeItem('recordArchive');
            updateRecordsDisplay();
            updateRecentRecordsDisplay();
            hideClearConfirmation();
            showStatus('æ‰€æœ‰è®°å½•å·²æ¸…é™¤');
        }

        function highlightText(text, searchTerm) {
            if (!searchTerm) return escapeHtml(text);
            
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return escapeHtml(text).replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
